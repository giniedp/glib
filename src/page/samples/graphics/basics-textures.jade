//- title: Textures
//- weight: 7
extends ./../../_layouts/example.jade
block script
  a(name="HTML" index=3)
  viewcode

  .grid-container
    p The following images and vides in the DOM can also be used as texutres.
  .grid-container(example)
    span: img.sample-texture(src='/assets/textures/proto_red.png' width='90' height='90')
    span: img.sample-texture(src='/assets/textures/proto_green.png' width='90' height='90')
    span: img.sample-texture(src='/assets/textures/proto_blue.png' width='90' height='90')
    span: video.sample-texture(src='/assets/videos/big-buck-bunny.mp4' width='160' height='90')

  a(name="VS" index=2)
  script#vertex-shader(type='text/glsl').
    precision highp float;

    // @binding position
    attribute vec3 vPosition;
    // @binding normal
    attribute vec3 vNormal;
    // @binding texture
    attribute vec2 vTexture;

    // @binding world
    uniform mat4 uWorld;
    // @binding view
    uniform mat4 uView;
    // @binding projection
    uniform mat4 uProjection;

    // data for fragment stage
    varying vec3 normal;
    varying vec3 position;
    varying vec2 texCoord;

    void main(void) {
      vec4 pos = uWorld * vec4(vPosition, 1.0);
      normal = mat3(uWorld) * vNormal;
      position = pos.xyz;
      texCoord = vTexture;
      gl_Position = uProjection * uView * pos;
    }

  a(name="FS" index=2)
  script#fragment-shader(type='text/glsl').
    precision highp float;
    // @binding texture
    uniform sampler2D uTexture;
    // @binding lightColor
    // @default [1, 1, 1]
    uniform vec3 uLightColor;
    // @binding lightDirection
    // @default [0, 0, -1]
    uniform vec3 uLightDirection;
    // @binding eyePosition
    // @default [0, 0, 1]
    uniform vec3 uEyePosition;
    // @binding specularPower
    // @default 16
    uniform float uSpecularPower;

    // data from vertex stage
    varying vec3 normal;
    varying vec3 position;
    varying vec2 texCoord;

    vec4 CalculateLightTerm(
      in vec3 E,   // Vector To Eye
      in vec3 N,   // Surface Normal
      in vec3 L,   // Vector To Light
      in vec3 LC,  // Light Color
      in float SP) // Specular Power
    {
      // diffuse term

      // float NdotL = max(0.0, dot(N, L));
      float NdotL = max(0.0, abs(dot(N, L))); // abs for backface
      vec4 result = vec4(NdotL * LC, 0.0);

      // specular term
      if (NdotL > 0.0)
      {
        vec3 H = normalize(E + L);
        result.a = pow(abs(dot(N, H)), SP);
      }
      return result;
    }
    
    void main(void) {
      vec4 term = CalculateLightTerm(uEyePosition - position, normal, -uLightDirection, uLightColor, uSpecularPower);
      vec4 color = texture2D(uTexture, texCoord);
      color.rgb = uLightColor * term.rgb * color.rgb + term.a * color.rgb;
      color.a = 1.0;  
      gl_FragColor = color;
    }
    
  a(name="JS" index=1)
  script(type='text/javascript').
    var device = new Glib.Graphics.Device({
      canvas: document.getElementById('canvas')
    });
    var program = device.createProgram({
      vertexShader: document.getElementById('vertex-shader').textContent,
      fragmentShader: document.getElementById('fragment-shader').textContent
    });
    
    var vertices = device.createVertexBuffer({
      layout: Glib.Graphics.VertexLayout.create('PositionNormalTexture'),
      data: [
      //    POSITION      NORMAL  TEXTURE
      //  X     Y    Z    X|Y|Z    U  V   
        -0.5, -0.5, 0.0,  0,0,1,   0, 1,
         0.5, -0.5, 0.0,  0,0,1,   1, 1,
        -0.5,  0.5, 0.0,  0,0,1,   0, 0,
         0.5,  0.5, 0.0,  0,0,1,   1, 0
      ]
    });
    var indices = device.createIndexBuffer({
      type: 'ushort',
      data: [0, 1, 2, 1, 2, 3]
    });

    // find all textures and video elements in this html document
    var texturesInDom = document.getElementsByClassName('sample-texture');
    // generate an array of textures
    var texturesFromDom = [];
    for (var i = 0; i < texturesInDom.length; i++) {
      texturesFromDom.push(device.createTexture({ data: texturesInDom.item(i) }));
    }

    // an array of image and video urls
    var textureUrls = [
      '/assets/textures/proto_red.png',
      '/assets/textures/proto_green.png',
      '/assets/textures/proto_blue.png',
      '/assets/videos/big-buck-bunny.mp4'
    ];
    // generate an array of textures
    var texturesFromUrls = textureUrls.map(function(url) {
      return device.createTexture({ data: url });
    })

    // enable autoplay of videos
    texturesFromDom.forEach(function(t) {
      if (t.video) {
        t.video.autoplay = true;
        t.video.oncanplay = function() {
          t.video.play();
        }
      }
    });
    texturesFromUrls.forEach(function(t) {
      if (t.video) {
        t.video.autoplay = true;
        t.video.oncanplay = function() {
          t.video.play();
        }
      }
    });

    var world = Glib.Mat4.identity();
    var view = Glib.Mat4.identity();
    var proj = Glib.Mat4.identity();

    Glib.utils.loop(function(dt) {
      // Resize and clear backbuffer 
      device.resize();
      device.clear(Glib.Graphics.Color.CornflowerBlue, 1.0);

      // Set current rendering objects
      device.program = program;
      device.indexBuffer = indices;
      device.vertexBuffer = vertices;

      // update view and projection matrices
      var aspect = device.context.drawingBufferWidth / device.context.drawingBufferHeight;
      view.initTranslation(0, 0, -1);  
      proj.initPerspectiveFieldOfView(Math.PI/2, aspect, 0, 100);
      // update view and projection matrices in shader
      program.setUniform('view', view);
      program.setUniform('projection', proj);

      // render textures from dom
      var count = texturesFromDom.length;
      for (var i = 0; i < count; i++) {
        world.initTranslation((i+0.5) - count/2, 0.5, -1);

        program.setUniform('texture', texturesFromDom[i]);
        program.setUniform('world', world);

        device.drawIndexedPrimitives('TriangleList', 0, 6);
      }

      // render textures from urls
      count = texturesFromUrls.length;
      for (var i = 0; i < count; i++) {
        world.initTranslation((i+0.5) - count/2, -0.5, -1);

        program.setUniform('texture', texturesFromUrls[i]);
        program.setUniform('world', world);

        device.drawIndexedPrimitives('TriangleList', 0, 6);
      }
    });
